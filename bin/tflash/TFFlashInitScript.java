package tfflash;

import com.pi4j.io.gpio.GpioController;
import com.pi4j.io.gpio.GpioFactory;
import com.pi4j.io.gpio.GpioPinDigitalOutput;
import com.pi4j.io.gpio.PinState;
import com.pi4j.io.gpio.RaspiPin;
import com.pi4j.io.spi.SpiChannel;
import com.pi4j.io.spi.SpiDevice;
import com.pi4j.io.spi.SpiFactory;

public class TFFlashInitScript {

    private static final int CS_PIN = 0;
    private static final int CLK_PIN = 1;
    private static final int DI_PIN = 2;
    private static final int DO_PIN = 3;

    private static SpiDevice spiDevice;

    public static void main(String... args) throws Exception {
        initializeGpio();
        configureLeds();
        initializeSpi();

        System.out.println("Initialization successful!");
        toggleAllLeds();

        Thread.sleep(5000);
        tearDown();
    }

    private static void initializeGpio() {
        GpioController gpio = GpioFactory.getInstance();
        ledRed = gpio.provisionDigitalOutputPin(RaspiPin.GPIO_01, "LED Red", PinState.LOW);
        ledGreen = gpio.provisionDigitalOutputPin(RaspiPin.GPIO_02, "LED Green", PinState.LOW);
        ledBlue = gpio.provisionDigitalOutputPin(RaspiPin.GPIO_03, "LED Blue", PinState.LOW);
    }

    private static void configureLeds() {
        ledRed.high();
        ledGreen.low();
        ledBlue.low();
    }

    private static void initializeSpi() throws Exception {
        SpiChannel channel = SpiFactory.getInstance().createSpiChannel(CLK_PIN, MOSI_PIN, MISO_PIN, CS_PIN);
        spiDevice = channel.getSpiDevice();

        // Send dummy command to MCP23017 IC
        sendCommand((byte) 0x40, new byte[]{0});
    }

    private static void sendCommand(byte addr, byte[] data) throws Exception {
        synchronized (spiDevice) {
            spiDevice.write(addr);
            spiDevice.write(data);
        }
    }

    private static void tearDown() {
        ledRed.setState(PinState.LOW);
        ledGreen.setState(PinState.LOW);
        ledBlue.setState(PinState.LOW);

        GpioFactory.getInstance().shutdown();
    }

    private static GpioPinDigitalOutput ledRed;
    private static GpioPinDigitalOutput ledGreen;
    private static GpioPinDigitalOutput ledBlue;

    private static final int MOSI_PIN = 10;
    private static final int MISO_PIN = 9;
}
